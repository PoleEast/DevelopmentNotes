# 測試計劃

## 測試優先度分析

基於後端代碼分析，以下是高優先度測試的建議：

### 1. 核心業務邏輯服務 (最高優先度)

#### UserService (`src/modules/user/user.service.ts`)

- **狀態**: 已有部分測試 ✓
- **需要加強測試**:
  - 密碼強度驗證
  - JWT token 生成與驗證
  - 用戶狀態更新邏輯
  - 數據庫事務回滾情況
- **風險等級**: 🔴 高風險 (用戶認證核心)

#### UserProfileService (`src/modules/userProfile/userProfile.service.ts`)

- **狀態**: 未測試 ❌
- **複雜度高，需要測試**:
  - 個人資料更新的事務處理 (`updateUserProfile`)
  - 頭像更新邏輯 (`updateAvatar`)
  - 關聯實體的映射邏輯 (countries, languages, currencies)
- **風險等級**: 🔴 高風險 (複雜事務邏輯)

### 2. 第三方整合服務 (高優先度)

#### GoogleService (`src/modules/google/google.service.ts`)

- **狀態**: 未測試 ❌
- **API 整合測試**:
  - 錯誤處理和重試邏輯
  - API 限額處理
  - 響應格式轉換
- **風險等級**: 🟡 中高風險 (外部依賴)

#### SearchLocationService (`src/modules/searchLocation/searchLocation.service.ts`)

- **狀態**: 未測試 ❌
- **業務邏輯測試**:
  - 價格等級映射 (`reversePriceLevelMapper`)
  - 搜索結果過濾和轉換
  - 自動完成功能
- **風險等級**: 🟡 中高風險 (業務邏輯複雜)

#### CloudinaryService (`src/modules/cloudinary/cloudinary.service.ts`)

- **狀態**: 未測試 ❌
- **檔案上傳測試**:
  - Base64 轉換邏輯
  - 上傳失敗處理
  - 檔案格式驗證
- **風險等級**: 🟡 中風險 (檔案處理)

### 3. 資料存取層 (中高優先度)

#### Repository 層測試

- **狀態**: 未測試 ❌
- **資料庫操作**:
  - 複雜查詢邏輯
  - 關聯表查詢
  - 事務處理
- **風險等級**: 🟡 中高風險 (數據完整性)

### 4. 全域處理器 (高優先度)

#### GlobalExceptionFilter (`src/common/filters/global_exception.filter.ts`)

- **狀態**: 未測試 ❌
- **錯誤處理測試**:
  - 不同例外類型的響應格式
  - 日誌記錄正確性
  - HTTP 狀態碼映射
- **風險等級**: 🔴 高風險 (系統穩定性)

#### JWT Strategy 與 Guards

- **狀態**: 未測試 ❌
- **認證授權測試**:
  - Token 驗證邏輯
  - 權限檢查
  - Cookie 提取邏輯
- **風險等級**: 🔴 高風險 (安全性)

### 5. 控制器層 (中優先度)

#### API 端點測試 (全部未測試)

- **狀態**: 未測試 ❌
- **測試項目**:
  - 請求驗證
  - 響應格式
  - 錯誤情況處理
- **風險等級**: 🟡 中風險 (API 契約)

## 建議的測試開發順序

1. **第一階段** (立即開始)
   - [x] UserService (補強現有測試)
   - [ ] GlobalExceptionFilter (錯誤處理)
   - [ ] JWT Strategy & Guards (認證安全)

2. **第二階段** (核心業務)
   - [ ] UserProfileService (事務邏輯)
   - [ ] AvatarService (頭像處理)

3. **第三階段** (第三方整合)
   - [ ] GoogleService (Google API)
   - [ ] SearchLocationService (搜索邏輯)
   - [ ] CloudinaryService (檔案上傳)

4. **第四階段** (資料層)
   - [ ] Repository 層 (資料存取)
   - [ ] 控制器層 (API 端點)

## 測試覆蓋率目標

### 短期目標 (1-2週)

- [ ] 核心認證服務 > 90%
- [ ] 錯誤處理機制 > 85%
- [ ] 用戶相關業務邏輯 > 80%

### 中期目標 (1個月)

- [ ] 所有服務層 > 80%
- [ ] 控制器層 > 70%
- [ ] 整體代碼覆蓋率 > 75%

### 長期目標 (2個月)

- [ ] 核心業務邏輯 > 90%
- [ ] API 端點 > 85%
- [ ] 整體代碼覆蓋率 > 80%

## 測試進度追蹤

### 🔴 高優先度 (必須完成)

- [x] UserService 基礎測試 (已完成)
- [x] UserService 進階測試補強 (✅ 21個測試全通過)
  - [x] 登錄異常處理 (JWT失敗、密碼比對異常、用戶資料不完整)
  - [x] 註冊異常處理 (資料庫保存失敗、密碼加密失敗、頭像服務異常)
  - [x] 更新用戶資料邊界測試
  - [x] 錯誤鏈追蹤和異常處理
- [ ] UserProfileService 完整測試套件
- [ ] GlobalExceptionFilter 測試
- [ ] JWT 認證流程測試

### 🟡 中優先度 (重要)

- [ ] GoogleService 模擬測試
- [ ] SearchLocationService 業務邏輯測試
- [ ] CloudinaryService 檔案處理測試
- [ ] Repository 層資料庫測試

### 🟢 低優先度 (可延後)

- [ ] 控制器 E2E 測試
- [ ] 性能測試
- [ ] 負載測試

## 測試策略

### 單元測試

- 使用 Jest 框架
- Mock 外部依賴
- 覆蓋核心業務邏輯

### 整合測試

- 資料庫整合測試
- 第三方 API 整合測試
- 服務間協作測試

### E2E 測試

- 關鍵用戶流程
- API 端點完整測試
- 錯誤情境處理

## 測試環境配置

### 開發環境測試

- 使用記憶體資料庫 (SQLite)
- Mock 第三方服務
- 快速回饋循環

### CI/CD 測試

- 自動化測試執行
- 代碼覆蓋率報告
- 測試結果通知

## 備註

- 測試開發應與功能開發並行進行
- 優先測試高風險、高複雜度的模組
- 定期檢視測試覆蓋率和測試品質
- 重構代碼時同步更新測試案例
